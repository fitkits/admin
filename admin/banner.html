<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!-- Tell the browser to be responsive to screen width -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <!-- Favicon icon -->
    <link rel="icon" type="image/png" sizes="16x16" href="../assets/images/favicon.png">
    <title>Fitkits - Admin Console</title>
    <!-- Bootstrap Core CSS -->
    <link href="../assets/plugins/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="../assets/plugins/perfect-scrollbar/css/perfect-scrollbar.css" rel="stylesheet">
    <link href="../assets/plugins/footable/css/footable.core.css" rel="stylesheet">
    <link href="../assets/plugins/select2/dist/css/select2.min.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="../assets/plugins/dropify/dist/css/dropify.min.css">
    <link href="css/style.css" rel="stylesheet">
    <!-- toast CSS -->
    <link href="../assets/plugins/toast-master/css/jquery.toast.min.css" rel="stylesheet">
    <!-- You can change the theme colors from here -->
    <link href="css/colors/default-dark.css" id="theme" rel="stylesheet">
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
        crossorigin="anonymous"></script>

    <script src="./js/Globals.js"></script>
    <script>

        $(document).ready(function () {

            console.log("sss", $(".datepicker"));
            $("#topbar_wrapper").load("./topbar.html", function () {
                console.log("loaded topbar");
            });
        });
    </script>
</head>

<body class="fix-header fix-sidebar card-no-border">
    <!-- ============================================================== -->
    <!-- Preloader - style you can find in spinners.css -->
    <!-- ============================================================== -->
    <div class="preloader">
        <div class="loader">
            <div class="loader__figure"></div>
            <p class="loader__label">Loading...</p>
        </div>
    </div>
    <!-- ============================================================== -->
    <!-- Main wrapper - style you can find in pages.scss -->
    <!-- ============================================================== -->
    <div id="main-wrapper">
        <div id="topbar_wrapper">

        </div>

        <!-- ============================================================== -->
        <!-- Page wrapper  -->
        <!-- ============================================================== -->
        <div class="page-wrapper">
            <!-- ============================================================== -->
            <!-- Container fluid  -->
            <!-- ============================================================== -->
            <div class="container-fluid">
                <!-- ============================================================== -->
                <!-- Bread crumb and right sidebar toggle -->
                <!-- ============================================================== -->
                <div class="row page-titles">
                    <div class="col-md-5 align-self-center">
                        <h3 class="text-themecolor">Banner Management</h3>
                    </div>
                    <div class="col-md-7 align-self-center">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item">
                                <a href="javascript:void(0)">Home</a>
                            </li>
                            <li class="breadcrumb-item active">banners</li>
                        </ol>
                    </div>
                </div>
                <!-- ============================================================== -->
                <!-- End Bread crumb and right sidebar toggle -->
                <!-- ============================================================== -->
                <div class="card">
                    <div class="card-body">
                        <div class="row form-material mb-0">
                            <div class="col-12 col-md-8">
                                <h4 class="card-title">Plans Available</h4>
                            </div>
                            <div class="col-12 col-md-4">
                                <div class="form-group mb-0">
                                    <div class="controls">
                                        <input id="filter" class="form-control" placeholder="Search plans" type="text" />
                                    </div>
                                </div>
                            </div>
                        </div>
                        <table id="banner-plan-table" class="table footable table-bordered table-striped border-0"
                            data-paging="true" data-sorting="true" data-page-size="6" data-page-navigation=".pagination"
                            data-filter="#filter" data-filter-text-only="true">
                            <thead>
                                <tr>
                                    <th><Title></Title></th>
                                    <th data-sort-ignore="true">Image</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="2" class="border-0">
                                        <button type="button" class="btn btn-info" data-toggle="modal" data-target="#add-banner-modal">Add
                                            New banner</button>
                                    </td>
                                    <td colspan="7" class="border-0">
                                        <div class="text-right">
                                            <ul class="pagination"> </ul>
                                        </div>
                                    </td>
                                </tr>
                            </tfoot>
                        </table>



                    </div>
                </div>
            </div>
            <!-- ============================================================== -->
            <!-- End Container fluid  -->
            <!-- ============================================================== -->
            <!-- ============================================================== -->
            <!-- footer -->
            <!-- ============================================================== -->
            <footer class="footer"> © 2017 Fitkits</footer>
            <!-- ============================================================== -->
            <!-- End footer -->
            <!-- ============================================================== -->
        </div>
        <!-- ============================================================== -->
        <!-- End Page wrapper  -->
        <!-- ============================================================== -->
    </div>
    <!-- ============================================================== -->
    <!-- Modals  -->
    <!-- ============================================================== -->
    <div id="add-banner-modal" class="modal fade in" tabindex="-1" role="dialog" aria-labelledby="add-banner-modal"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">New banner</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                </div>
                <div class="modal-body">
                    <form id="add-banner-form" class="form-material" novalidate>
                        <div class="form-group">
                            <div class="controls">
                                <input type="text" class="form-control" name="title" placeholder="Banner Title" required>
                            </div>
                        </div>
                        <div class="form-group">
                            banner Image
                            <div class="controls">
                                <input type="file" class="dropify" name="bannerImage" data-height="100" />
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-info waves-effect" form="add-banner-form">Save</button>
                    <button type="button" class="btn btn-default waves-effect" data-dismiss="modal">Cancel</button>
                </div>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>
    <div id="edit-banner-modal" class="modal fade in" tabindex="-1" role="dialog" aria-labelledby="edit-banner-modal"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Edit banner</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                </div>
                <div class="modal-body">
                    <form id="edit-banner-form" class="form-material" novalidate>
                        <input type="hidden" name="banner_id">
                        <div class="form-group">
                            <div class="controls">
                                <input type="text" class="form-control" name="title" placeholder="Banner Title" required>
                            </div>
                        </div>
                        <div>
                            <p class="text-truncate">File Present :
                                <span style="color:green;" id="edit_banner_image">
                                </span>
                            </p>
                        </div>
                        <div class="form-group">
                            <div class="controls">
                                <input type="file" class="dropify" name="bannerImage" data-height="300" />
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-info waves-effect" form="edit-banner-form">Update</button>
                    <button type="button" class="btn btn-default waves-effect" data-dismiss="modal">Cancel</button>
                </div>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>
    <div id="user-payment-raw-modal" class="modal fade in" tabindex="-1" role="dialog" aria-labelledby="user-payment-raw-modal"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Add a new banner</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                </div>
                <div class="modal-body">
                    <form id="user-payment-raw-form" class="form-material" novalidate>
                        <div class="form-group">
                            <div class="controls">
                                <h5>User</h5>
                                <select id="users-select-raw" name="userId" class="select2 users form-control custom-select"
                                    style="width: 100%; height:36px;">
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="controls">
                                <h5>banner</h5>
                                <select id="banners-select-raw" name="bannerId" class="select2 banners form-control custom-select"
                                    style="width: 100%; height:36px;">
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="controls">
                                <input type="text" class="form-control" name="comment" placeholder="comments">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success waves-effect" form="user-payment-raw-form">Pay</button>
                    <button type="button" class="btn btn-default waves-effect" data-dismiss="modal">Cancel</button>
                </div>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>
    <!-- ============================================================== -->
    <!-- End Wrapper -->
    <!-- ============================================================== -->
    <!-- ============================================================== -->
    <!-- All Jquery -->
    <!-- ============================================================== -->
    <script src="../assets/plugins/jquery/jquery.min.js"></script>
    <!-- Bootstrap popper Core JavaScript -->
    <script src="../assets/plugins/bootstrap/js/popper.min.js"></script>
    <script src="../assets/plugins/bootstrap/js/bootstrap.min.js"></script>
    <!-- slimscrollbar scrollbar JavaScript -->
    <script src="js/perfect-scrollbar.jquery.min.js"></script>
    <script src="https://unpkg.com/sweetalert2@7.1.0/dist/sweetalert2.all.js"></script>
    <!--Wave Effects -->
    <script src="js/waves.js"></script>
    <!--Menu sidebar -->
    <script src="js/sidebarmenu.js"></script>
    <!--Custom JavaScript -->
    <script src="js/custom.min.js"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script src="../assets/plugins/toast-master/js/jquery.toast.min.js"></script>
    <script src="../assets/plugins/footable/js/footable.all.min.js"></script>
    <script src="../assets/plugins/wizard/jquery.validate.min.js"></script>
    <script src="../assets/plugins/moment/min/moment.min.js"></script>
    <script src="../assets/plugins/select2/dist/js/select2.full.min.js" type="text/javascript"></script>
    <script src="../assets/plugins/dropify/dist/js/dropify.min.js"></script>
    <script src="js/utils/helper.js"></script>
    <script src="js/utils/localStorageWrapper.js"></script>
    <script src="./js/utils/paginatedAjax.js"></script>
    <script src="js/banners/banners.js"></script>
    <script>
        $(".banners").select2({
            language: {
                noResults: function (params) {
                    return "No banner found";
                }
            }
        });
        $(".users").select2({
            language: {
                noResults: function (params) {
                    return "No Users found";
                }
            }
        });




        function approveUser(row) {
            const $rowToBeApproved = $(row).parents('tr');
            const _currentbanner = BANNERS_LIST.find(banner => {
                console.log("IDS", banner._id, $rowToBeApproved.data('mid'))
                return banner._id === $rowToBeApproved.data('mid');
            });


            let amt = _currentbanner.cost;
            let _data = {
                banner: _currentbanner._id,
                user: $rowToBeApproved.data('uid'),
                paymentType: "OFFLINE",
                amountPaid: amt,
                comments: ""
            };
            console.log(_data)
            settings = {
                url: BASE_URL + `/api/v1/cms/subscriptions/create`,
                method: "POST",
                data: JSON.stringify(_data),

                beforeSend: function (xhr) {
                    xhr.setRequestHeader(
                        "Authorization",
                        // "Basic " + btoa(username + ":" + password)
                        "Bearer " + localStorage.getItem("token")
                    );
                    xhr.setRequestHeader("content-type", "application/json");
                }
            };
            $.ajax(settings).done((response, textStatus, request) => {
                console.log("create subscription", response);

                settings = {
                    url: BASE_URL + `/api/v1/cms/users/${$rowToBeApproved.data('uid')}`,
                    method: "PATCH",

                    beforeSend: function (xhr) {
                        xhr.setRequestHeader(
                            "Authorization",
                            // "Basic " + btoa(username + ":" + password)
                            "Bearer " + localStorage.getItem("token")
                        );
                        xhr.setRequestHeader(
                            "content-type",
                            "application/x-www-form-urlencoded"
                        );
                    },
                    data: {
                        "name": "Ragzzy",
                        "pendingbanner": {

                            "isPending": false,
                            "subscription": response.Subscriptions._id,
                            "bannerId": _currentbanner._id
                        }
                    }

                };
                $.ajax(settings)
                    .done((response, textStatus, request) => {

                        swal({
                            position: "top-right",
                            type: "success",
                            title: "Successfully Approved",
                            showConfirmButton: false,
                            timer: 1500
                        });
                        location.reload();
                    })
                    .fail(xhr => {
                        swal({
                            title: "Oops...",
                            text: "banner cannot be added.",
                            type: "error",
                            confirmButtonColor: "#DD6B55"
                        });
                    });
            });
        }
        function deleteRow(row) {
            var $rowToBeDeleted = $(row).parents('tr');
            $.ajax({
                method: 'DELETE',
                url: BASE_URL + `/api/v1/cms/banners/${$rowToBeDeleted.data('mid')}`,
                beforeSend: function (xhr) {
                    xhr.setRequestHeader(
                        "Authorization",
                        // "Basic " + btoa(username + ":" + password)
                        "Bearer " + localStorage.getItem("token")
                    )
                }
            })
                .done((response, textStatus, request) => {
                    console.log(BANNERS_LIST);
                    BANNERS_LIST.splice(BANNERS_LIST.findIndex(banner => {
                        return banner._id === $rowToBeDeleted.data('mid')
                    }), 1);
                    swal({
                        position: 'top-right',
                        type: 'success',
                        title: 'Successfully deleted',
                        showConfirmButton: false,
                        timer: 1500
                    })
                    $rowToBeDeleted.remove();
                })
                .fail(xhr => {
                    swal({
                        title: 'Oops...',
                        text: 'Something went wrong!',
                        type: 'error',
                        confirmButtonColor: "#DD6B55",
                    })
                });
        }
    </script>
</body>

</html>